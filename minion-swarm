#!/usr/bin/env bash
set -euo pipefail

SOURCE_PATH="${BASH_SOURCE[0]}"
while [[ -L "${SOURCE_PATH}" ]]; do
  SOURCE_DIR="$(cd -P "$(dirname "${SOURCE_PATH}")" && pwd)"
  SOURCE_PATH="$(readlink "${SOURCE_PATH}")"
  [[ "${SOURCE_PATH}" != /* ]] && SOURCE_PATH="${SOURCE_DIR}/${SOURCE_PATH}"
done
ROOT_DIR="$(cd -P "$(dirname "${SOURCE_PATH}")" && pwd)"
VENV_PY="${ROOT_DIR}/.venv/bin/python3"
DEFAULT_CONFIG="${MINION_SWARM_CONFIG:-${HOME}/.minion-swarm/minion-swarm.yaml}"
export PYTHONPATH="${ROOT_DIR}${PYTHONPATH:+:${PYTHONPATH}}"

if [[ ! -x "${VENV_PY}" ]]; then
  python3 -m venv "${ROOT_DIR}/.venv"
fi

if ! "${VENV_PY}" -m pip --version >/dev/null 2>&1; then
  "${VENV_PY}" -m ensurepip --upgrade >/dev/null 2>&1 || true
fi

if ! "${VENV_PY}" -c "import click, yaml, watchdog" >/dev/null 2>&1; then
  "${VENV_PY}" -m pip install -r "${ROOT_DIR}/requirements.txt"
fi

if [[ $# -eq 0 ]]; then
  exec "${VENV_PY}" -m minion_swarm.cli --help
fi

if [[ -f "${DEFAULT_CONFIG}" ]]; then
  has_config_flag=0
  for arg in "$@"; do
    if [[ "${arg}" == "--config" ]]; then
      has_config_flag=1
      break
    fi
  done

  if [[ "${has_config_flag}" -eq 0 ]]; then
    exec "${VENV_PY}" -m minion_swarm.cli "$@" --config "${DEFAULT_CONFIG}"
  fi
fi

exec "${VENV_PY}" -m minion_swarm.cli "$@"
